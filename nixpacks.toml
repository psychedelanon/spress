[nixpacks]
plan = "node"

[variables]
BP_NODE_VERSION = "20"

[phases.install]
cmds = ["npm ci --no-audit --no-fund"]

[phases.build]
cmds = [
  "npm run build",
  "mkdir -p webapp/dist",
  "echo '<!DOCTYPE html><html lang=\"en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"><title>SPRESS Chess</title><script src=\"https://telegram.org/js/telegram-web-app.js\"></script><script crossorigin src=\"https://unpkg.com/react@18/umd/react.production.min.js\"></script><script crossorigin src=\"https://unpkg.com/react-dom@18/umd/react-dom.production.min.js\"></script><script src=\"https://unpkg.com/chess.js@1.4.0/chess.js\"></script><style>*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif}body{background:#00102E;color:white;overflow:hidden}.app{height:100vh;width:100vw;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem}.header{font-size:2rem;font-weight:bold;color:#0053FF;margin-bottom:1rem;text-align:center}.board-container{border:4px solid #E01313;border-radius:8px;background:white;padding:8px;margin:1rem 0}.chessboard{width:300px;height:300px;display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr)}.square{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer}.light{background:#f0d9b5}.dark{background:#b58863}.piece{font-size:28px;user-select:none}.status{font-size:1.1rem;margin:1rem 0;text-align:center;color:#FFD700}.loading{font-size:1.2rem;color:#FFD700;text-align:center}@media (max-width:480px){.chessboard{width:280px;height:280px}.piece{font-size:24px}}</style></head><body><div id=\"root\"><div class=\"app\"><div class=\"header\">SPRESS</div><div class=\"loading\">Loading chess game...</div><div class=\"board-container\"><div class=\"chessboard\" id=\"chessboard\"></div></div><div class=\"status\">Connecting to game...</div></div></div><script>const {useState,useEffect}=React;const pieceSymbols={\"K\":\"♔\",\"Q\":\"♕\",\"R\":\"♖\",\"B\":\"♗\",\"N\":\"♘\",\"P\":\"♙\",\"k\":\"♚\",\"q\":\"♛\",\"r\":\"♜\",\"b\":\"♝\",\"n\":\"♞\",\"p\":\"♟\"};function createBoard(fen){const board=document.getElementById(\"chessboard\");if(!board)return;board.innerHTML=\"\";const rows=fen.split(\" \")[0].split(\"/\");for(let rank=0;rank<8;rank++){for(let file=0;file<8;file++){const square=document.createElement(\"div\");square.className=\"square \"+((rank+file)%2===0?\"light\":\"dark\");const squareName=String.fromCharCode(97+file)+(8-rank);square.dataset.square=squareName;board.appendChild(square)}}rows.forEach((row,rankIndex)=>{let fileIndex=0;for(const char of row){if(/\\d/.test(char)){fileIndex+=parseInt(char)}else{const squareName=String.fromCharCode(97+fileIndex)+(8-rankIndex);const squareEl=board.querySelector(`[data-square=\"${squareName}\"]`);if(squareEl&&pieceSymbols[char]){const piece=document.createElement(\"span\");piece.className=\"piece\";piece.textContent=pieceSymbols[char];piece.dataset.piece=char;squareEl.appendChild(piece)}fileIndex++}}})}function App(){const [gameState,setGameState]=useState(\"loading\");const [playerColor,setPlayerColor]=useState(\"white\");const [position,setPosition]=useState(\"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1\");const [ws,setWs]=useState(null);useEffect(()=>{if(window.Telegram?.WebApp){window.Telegram.WebApp.ready();window.Telegram.WebApp.expand()}const wsProtocol=window.location.protocol===\"https:\"?\"wss:\":\"ws:\";const wsHost=window.location.hostname+(window.location.port?\":\"+window.location.port:\"\");const wsUrl=wsProtocol+\"//\"+wsHost+\"/ws?session=test&color=w\";console.log(\"Connecting to:\",wsUrl);try{const websocket=new WebSocket(wsUrl);websocket.onopen=()=>{console.log(\"WebSocket connected\");setGameState(\"connected\");setWs(websocket)};websocket.onerror=(error)=>{console.error(\"WebSocket error:\",error);setGameState(\"error\")};websocket.onclose=()=>{console.log(\"WebSocket disconnected\");setGameState(\"disconnected\")};websocket.onmessage=(event)=>{const data=JSON.parse(event.data);if(data.type===\"update\"){setPosition(data.fen);console.log(\"Updated position:\",data.fen)}}}catch(error){console.error(\"Failed to create WebSocket:\",error);setGameState(\"error\")}},[]);useEffect(()=>{createBoard(position)},[position]);return React.createElement(\"div\",{className:\"app\"},React.createElement(\"div\",{className:\"header\"},\"SPRESS\"),React.createElement(\"div\",{className:\"loading\"},gameState===\"loading\"?\"Loading chess game...\":gameState===\"connected\"?\"Game ready!\":gameState===\"error\"?\"Connection error\":\"Disconnected\"),React.createElement(\"div\",{className:\"board-container\"},React.createElement(\"div\",{className:\"chessboard\",id:\"chessboard\"})),React.createElement(\"div\",{className:\"status\"},\"Playing as \"+playerColor))}const root=ReactDOM.createRoot(document.getElementById(\"root\"));root.render(React.createElement(App));</script></body></html>' > webapp/dist/index.html",
  "ls -la webapp/dist/"
]

[start]
cmd = "node dist/server.js" 